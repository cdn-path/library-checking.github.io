<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î</title>
  <link href="https://fonts.googleapis.com/css2/family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .swal2-popup {
      font-family: 'Prompt', sans-serif !important;
      border-radius: 1rem !important;
      background-color: #fff1f8 !important;
    }
    .swal2-title {
      color: #9f2a44 !important;
      font-size: 1.5rem !important;
    }
    .swal2-content {
      color: #4a4a !important;
      font-size: 1.125rem !important;
    }
    .swal2-confirm {
      background-color: #f472b6 !important;
      color: white !important;
      border-radius: 0.5rem !important;
      padding: 0.5rem 1.5rem !important;
    }
  </style>
</head>
<body class="bg-pink-50 font-sans min-h-screen p-4 sm:p-6">
  <div class="max-w-5xl mx-auto">
    <div class="flex justify-center mb-6">
      <img id="logo" src="https://subrkzuuirqkghijkdab.supabase.co/storage/v1/object/public/image%20fo%20library%20project/logo/3dgifmaker20996.gif" width="150px" alt="Library Logo">
    </div>
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-pink-700 mb-6">‡∏´‡∏≠‡∏™‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏Å‡∏•‡∏á "‡∏ß‡∏¥‡∏ó‡∏¢‡∏™‡∏ñ‡∏≤‡∏ß‡∏£"</h1>
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <input type="text" id="studentIdInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="p-3 border border-pink-200 rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-pink-400 bg-white text-lg text-gray-700" autofocus>
    </div>
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <input type="date" id="dateFilter" class="p-3 border border-pink-200 rounded-lg bg-white text-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">
    </div>
    <div id="studentInfo" class="bg-white p-6 rounded-lg shadow-lg mb-6 border border-pink-100">
      <p class="text-lg text-gray-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    </div>
    <div id="stats" class="bg-white p-6 rounded-lg shadow-lg mb-6 border border-purple-100">
      <h2 class="text-xl font-semibold text-purple-700 mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
        <div class="bg-purple-50 p-4 rounded-lg text-center">
          <p class="text-sm font-medium text-purple-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          <p class="text-2xl font-bold text-purple-800" id="totalCount">0</p>
        </div>
        <div class="bg-blue-50 p-4 rounded-lg text-center">
          <p class="text-sm font-medium text-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢</p>
          <p class="text-2xl font-bold text-blue-800" id="maleCount">0</p>
        </div>
        <div class="bg-pink-50 p-4 rounded-lg text-center">
          <p class="text-sm font-medium text-pink-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á</p>
          <p class="text-2xl font-bold text-pink-800" id="femaleCount">0</p>
        </div>
      </div>
      <div class="h-64">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-lg border border-pink-100 overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="bg-pink-100">
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏™‡∏Å‡∏∏‡∏•</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <footer style="color: #ffffff; background-color: #000000aa; padding: 5px; text-align: center; display: flex; justify-content: center; align-items: center; width: 100%; position: fixed; bottom: 0; left: 0;">
    ¬©Ô∏è <span id="yearFooter"></span>
    <img src="https://aliyahaunjo.github.io/image/kruaun.png" width="30px" alt="Developer Logo"> ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡πã‡∏ô ‡πÉ‡∏à‡∏î‡∏µ
  </footer>

<script>
  let studentData = [];
  let recordedData = [];
  let filteredData = [];
  let isDataLoaded = false;
  const studentIdInput = document.getElementById('studentIdInput');
  const tableBody = document.getElementById('tableBody');
  const studentInfoDiv = document.getElementById('studentInfo');
  const dateFilter = document.getElementById('dateFilter');
  let chartInstance = null;
  const API_URL = 'https://subrkzuuirqkghijkdab.supabase.co/functions/v1/library-checking';
  let debounceTimeout = null;

  // Helper function to convert DD/MM/YYYY to YYYY-MM-DD
  function convertToISODate(dateStr) {
    if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
      console.warn(`Invalid date format: ${dateStr}`);
      return null;
    }
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  }

  // Helper function to convert YYYY-MM-DD to DD/MM/YYYY
  function convertToThaiDate(dateStr) {
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      console.warn(`Invalid ISO date format: ${dateStr}`);
      return null;
    }
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
  }

  // Error handling
  function onFailure(error, customMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î') {
    console.error('Error:', error);
    Swal.fire({
      title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: `${customMessage}: ${error.message}`,
      icon: 'error',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
    }).then(() => {
      studentIdInput.value = '';
      studentIdInput.focus();
    });
  }

  // Load student data
  async function loadStudentData() {
    try {
      const response = await fetch(`${API_URL}/students`, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      studentData = data;
      isDataLoaded = true;
      console.log('studentData updated:', studentData);
      console.log('Available student IDs:', studentData.map(s => s.id));
      return data;
    } catch (error) {
      isDataLoaded = false;
      studentData = [];
      onFailure(error, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ');
      throw error;
    }
  }

  // Load attendance data
  async function loadAttendanceData() {
    try {
      const response = await fetch(`${API_URL}/attendance`, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      // Convert date field from DD/MM/YYYY to YYYY-MM-DD
      recordedData = data.map(record => ({
        ...record,
        date: convertToISODate(record.date) || new Date(record.timestamp).toISOString().split('T')[0]
      }));
      console.log('Attendance data received:', recordedData);
      console.log('Dates in recordedData:', recordedData.map(r => r.date));
      return recordedData;
    } catch (error) {
      recordedData = [];
      onFailure(error, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
      throw error;
    }
  }

  // Search student and record attendance
  async function searchStudent() {
    if (!isDataLoaded) {
      Swal.fire({
        title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
        icon: 'error',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      }).then(() => {
        studentIdInput.value = '';
        studentIdInput.focus();
      });
      return;
    }

    const id = studentIdInput.value.trim();
    if (!id) {
      return; // Silently ignore empty input to avoid unnecessary alerts during typing
    }

    try {
      console.log(`Searching for student ID: ${id}`);
      let student = studentData.find(s => String(s.id).trim() === id);
      if (!student) {
        const response = await fetch(`${API_URL}/students/${encodeURIComponent(id)}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Student not found');
        }
        student = await response.json();
        console.log(`Student fetched from API: ${JSON.stringify(student)}`);
      }

      if (student) {
        const now = new Date();
        const timestamp = `${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH', { timeZone: 'Asia/Bangkok' })}`;
        const recordedStudent = {
          id: student.id,
          prefix: student.prefix || '',
          firstName: student.firstName || '',
          lastName: student.lastName || '',
          timestamp,
          date: now.toISOString().split('T')[0]
        };

        console.log(`Sending attendance data: ${JSON.stringify(recordedStudent)}`);
        const response = await fetch(`${API_URL}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(recordedStudent)
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to record attendance');
        }

        const data = await response.json();
        recordedData.unshift(data);
        filterByDate();
        updateStudentInfo(student);
        Swal.fire({
          title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${student.prefix}${student.firstName} ${student.lastName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          icon: 'success',
          timer: 1500,
          showConfirmButton: false
        }).then(() => {
          studentIdInput.value = '';
          studentIdInput.focus();
        });
      } else {
        Swal.fire({
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ ${id}`,
          icon: 'warning',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then(() => {
          studentIdInput.value = '';
          studentIdInput.focus();
        });
      }
    } catch (error) {
      onFailure(error, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
    }
  }

  // Filter data by date
  function filterByDate() {
    try {
      const selectedDate = dateFilter.value; // YYYY-MM-DD
      console.log('Selected date:', selectedDate);
      if (!selectedDate) {
        filteredData = recordedData;
      } else {
        filteredData = recordedData.filter(record => {
          const recordDate = record.date; // YYYY-MM-DD
          console.log(`Comparing record date: ${recordDate} with selected date: ${selectedDate}`);
          return recordDate === selectedDate;
        });
      }
      console.log('Filtered data:', filteredData);
      updateTable();
      updateStats();
    } catch (error) {
      console.error('Error filtering by date:', error);
      Swal.fire({
        title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ' + error.message,
        icon: 'error',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      });
    }
  }

  // Update attendance table
  function updateTable() {
    tableBody.innerHTML = '';
    if (filteredData.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="p-3 text-center text-gray-700 text-base">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td>
        </tr>
      `;
    } else {
      filteredData.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-pink-50';
        row.innerHTML = `
          <td class="p-3 text-gray-700 text-base">${record.id}</td>
          <td class="p-3 text-gray-700 text-base">${record.prefix}</td>
          <td class="p-3 text-gray-700 text-base">${record.firstName}</td>
          <td class="p-3 text-gray-700 text-base">${record.lastName}</td>
          <td class="p-3 text-gray-700 text-base">${record.timestamp}</td>
        `;
        tableBody.appendChild(row);
      });
    }
  }

  // Update student info
  function updateStudentInfo(student) {
    studentInfoDiv.innerHTML = `
      <p class="text-base text-gray-700"><strong class="text-pink-700">‡∏ä‡∏±‡πâ‡∏ô:</strong> ${student.class}</p>
      <p class="text-base text-gray-700"><strong class="text-pink-700">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${student.number}</p>
      <p class="text-base text-gray-700"><strong class="text-pink-700">‡∏£‡∏´‡∏±‡∏™:</strong> ${student.id}</p>
      <p class="text-base text-gray-700"><strong class="text-pink-700">‡∏ä‡∏∑‡πà‡∏≠:</strong> ${student.prefix}${student.firstName} ${student.lastName}</p>
    `;
  }

  // Update stats and chart
  function updateStats() {
    const totalCount = filteredData.length;
    const maleCount = filteredData.filter(record => record.prefix === '‡∏ô‡∏≤‡∏¢' || record.prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢').length;
    const femaleCount = filteredData.filter(record => record.prefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' || record.prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á').length;

    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('maleCount').textContent = maleCount;
    document.getElementById('femaleCount').textContent = femaleCount;

    if (chartInstance && typeof chartInstance.destroy === 'function') {
      chartInstance.destroy();
    }

    const ctx = document.getElementById('attendanceChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
        datasets: [{
          data: [maleCount, femaleCount],
          backgroundColor: ['#60A5FA', '#F472B6'],
          borderColor: ['#ffffff', '#ffffff'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#4B5563',
              font: { size: 14, family: "'Prompt', sans-serif" }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw || 0;
                const label = context.label || '';
                return `${label}: ${value} ‡∏Ñ‡∏ô`;
              }
            }
          }
        }
      }
    });
  }

  // Debounce function to delay search
  function debounce(func, wait) {
    return function executedFunction(...args) {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Trigger search with debounce
  studentIdInput.addEventListener('input', debounce(() => {
    searchStudent();
  }, 1000));

  window.onload = async () => {
    try {
      document.getElementById('yearFooter').textContent = new Date().getFullYear();
      await Promise.all([loadStudentData(), loadAttendanceData()]);
      dateFilter.value = new Date().toISOString().split('T')[0];
      filterByDate();
      studentIdInput.focus();
    } catch (error) {
      console.error('Error during initial data load:', error);
      Swal.fire({
        title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`,
        icon: 'error',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      });
    }
  };

  dateFilter.addEventListener('change', filterByDate);
</script>
</body>
</html>
