<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .swal2-popup {
      font-family: 'Prompt', sans-serif !important;
      border-radius: 1rem !important;
      background-color: #fff1f8 !important;
    }
    .swal2-title {
      color: #9f2a44 !important;
      font-size: 1.5rem !important;
    }
    .swal2-content {
      color: #4a4a4a !important;
      font-size: 1.125rem !important;
    }
    .swal2-confirm {
      background-color: #f472b6 !important;
      color: white !important;
      border-radius: 0.5rem !important;
      padding: 0.5rem 1.5rem !important;
    }
  </style>
</head>
<body class="bg-pink-50 font-sans min-h-screen p-4 sm:p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-pink-700 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î</h1>
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <input type="text" id="studentIdInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏ï‡∏±‡∏ß)" class="p-3 border border-pink-200 rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-pink-400 bg-white text-lg text-gray-700" maxlength="5" pattern="[0-9]*" inputmode="numeric" autofocus>
    </div>
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <input type="date" id="dateFilter" class="p-3 border border-pink-200 rounded-lg bg-white text-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">
    </div>
    <div id="studentInfo" class="bg-white p-6 rounded-lg shadow-lg mb-6 border border-pink-100">
      <p class="text-lg text-gray-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    </div>
    <div id="stats" class="bg-white p-6 rounded-lg shadow-lg mb-6 border border-purple-100">
      <h2 class="text-xl font-semibold text-purple-700 mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
        <div class="bg-purple-50 p-4 rounded-lg text-center">
          <p class="text-sm font-medium text-purple-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          <p class="text-2xl font-bold text-purple-800" id="totalCount">0</p>
        </div>
        <div class="bg-blue-50 p-4 rounded-lg text-center">
          <p class="text-sm font-medium text-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢</p>
          <p class="text-2xl font-bold text-blue-800" id="maleCount">0</p>
        </div>
        <div class="bg-pink-50 p-4 rounded-lg text-center">
          <p class="text-sm font-medium text-pink-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ç‡∏¥‡∏á</p>
          <p class="text-2xl font-bold text-pink-800" id="femaleCount">0</p>
        </div>
      </div>
      <div class="h-64">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-lg border border-pink-100 overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="bg-pink-100">
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡∏™‡∏Å‡∏∏‡∏•</th>
            <th class="p-3 text-left text-pink-700 font-semibold text-lg">‡πÄ‡∏ß‡∏•‡∏≤</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <footer style="color: #ffffff; background-color: #000000aa; padding: 5px; text-align: center; display: flex; justify-content: center; align-items: center; width: 100%; position: fixed; bottom: 0; left: 0;">
    ¬©Ô∏è <span id="yearFooter"></span>
    <img src="https://aliyahaunjo.github.io/image/kruaun.png" width="30px;"> ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡πã‡∏ô ‡πÉ‡∏à‡∏î‡∏µ
  </footer>

  <script>
    let studentData = [];
    let recordedData = [];
    let filteredData = [];
    let isDataLoaded = false;
    const studentIdInput = document.getElementById('studentIdInput');
    const tableBody = document.getElementById('tableBody');
    const studentInfoDiv = document.getElementById('studentInfo');
    const dateFilter = document.getElementById('dateFilter');
    let chartInstance = null;
    const API_URL = 'https://subrkzuuirqkghijkdab.supabase.co/functions/v1/library-checking'; // Replace with your Edge Function URL

    // Error handling
    function onFailure(error) {
      console.error('Error:', error);
      Swal.fire({
        title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message,
        icon: 'error',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      }).then(() => {
        studentIdInput.value = '';
        studentIdInput.focus();
      });
    }

    // Load student data
    async function loadStudentData() {
      try {
        const response = await fetch(`${API_URL}/students`, { method: 'GET' });
        if (!response.ok) throw new Error('Failed to fetch student data');
        const data = await response.json();
        studentData = data;
        isDataLoaded = true;
        console.log('studentData updated:', studentData);
        console.log('Available student IDs:', studentData.map(s => s.id));
        return data;
      } catch (error) {
        isDataLoaded = false;
        studentData = [];
        onFailure(error);
        throw error;
      }
    }

    // Load attendance data
    async function loadAttendanceData() {
      try {
        const response = await fetch(`${API_URL}/attendance`, { method: 'GET' });
        if (!response.ok) throw new Error('Failed to fetch attendance data');
        const data = await response.json();
        recordedData = data;
        console.log('Attendance data received:', data);
        return data;
      } catch (error) {
        recordedData = [];
        onFailure(error);
        throw error;
      }
    }

    // Search student and record attendance
    async function searchStudent() {
      if (!isDataLoaded) {
        Swal.fire({
          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
          icon: 'error',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then(() => {
          studentIdInput.value = '';
          studentIdInput.focus();
        });
        return;
      }

      const id = studentIdInput.value.trim();
      if (!id || id.length !== 5 || !/^\d{5}$/.test(id)) {
        Swal.fire({
          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç',
          icon: 'warning',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then(() => {
          studentIdInput.value = '';
          studentIdInput.focus();
        });
        return;
      }

      try {
        let student = studentData.find(s => String(s.id).trim() === id);
        if (!student) {
          const response = await fetch(`${API_URL}/students/${id}`, { method: 'GET' });
          if (!response.ok) throw new Error('Student not found');
          student = await response.json();
        }

        if (student) {
          const now = new Date();
          const timestamp = `${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH', { timeZone: 'Asia/Bangkok' })}`;
          const recordedStudent = { ...student, timestamp, date: now.toLocaleDateString('th-TH') };

          const response = await fetch(`${API_URL}/attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(recordedStudent)
          });
          if (!response.ok) throw new Error('Failed to record attendance');

          recordedData.unshift(recordedStudent);
          filterByDate();
          updateStudentInfo(student);
          Swal.fire({
            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${student.prefix}${student.firstName} ${student.lastName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            studentIdInput.value = '';
            studentIdInput.focus();
          });
        } else {
          Swal.fire({
            title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            text: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ ${id}`,
            icon: 'warning',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
          }).then(() => {
            studentIdInput.value = '';
            studentIdInput.focus();
          });
        }
      } catch (error) {
        onFailure(error);
      }
    }

    // Filter data by date
    function filterByDate() {
      const selectedDate = dateFilter.value ? new Date(dateFilter.value).toLocaleDateString('th-TH') : new Date().toLocaleDateString('th-TH');
      filteredData = recordedData.filter(record => record.date === selectedDate);
      updateTable();
      updateStats();
    }

    // Update attendance table
    function updateTable() {
      tableBody.innerHTML = '';
      filteredData.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-pink-50';
        row.innerHTML = `
          <td class="p-3 text-gray-700 text-base">${record.id}</td>
          <td class="p-3 text-gray-700 text-base">${record.prefix}${record.firstName}</td>
          <td class="p-3 text-gray-700 text-base">${record.lastName}</td>
          <td class="p-3 text-gray-700 text-base">${record.timestamp}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Update student info
    function updateStudentInfo(student) {
      studentInfoDiv.innerHTML = `
        <p class="text-base text-gray-700"><strong class="text-pink-700">‡∏£‡∏´‡∏±‡∏™:</strong> ${student.id}</p>
        <p class="text-base text-gray-700"><strong class="text-pink-700">‡∏ä‡∏∑‡πà‡∏≠:</strong> ${student.prefix}${student.firstName} ${student.lastName}</p>
      `;
    }

    // Update stats and chart
    function updateStats() {
      const totalCount = filteredData.length;
      const maleCount = filteredData.filter(record => record.prefix === '‡∏ô‡∏≤‡∏¢' || record.prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢').length;
      const femaleCount = filteredData.filter(record => record.prefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' || record.prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á').length;

      document.getElementById('totalCount').textContent = totalCount;
      document.getElementById('maleCount').textContent = maleCount;
      document.getElementById('femaleCount').textContent = femaleCount;

      if (chartInstance && typeof chartInstance.destroy === 'function') {
        chartInstance.destroy();
      }

      const ctx = document.getElementById('attendanceChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
          datasets: [{
            data: [maleCount, femaleCount],
            backgroundColor: ['#60A5FA', '#F472B6'],
            borderColor: ['#ffffff', '#ffffff'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#4B5563',
                font: { size: 14, family: "'Prompt', sans-serif" }
              }
            }
          }
        }
      });
    }

    // Auto-search when 5 digits are entered
    studentIdInput.addEventListener('input', () => {
      const value = studentIdInput.value.trim();
      if (value.length === 5 && /^\d{5}$/.test(value)) {
        searchStudent();
      }
    });

    // Restrict input to numbers
    studentIdInput.addEventListener('keypress', (e) => {
      const charCode = e.charCode;
      if (charCode < 48 || charCode > 57) {
        e.preventDefault();
      }
    });

    window.onload = async () => {
      try {
        document.getElementById('yearFooter').textContent = new Date().getFullYear();
        await Promise.all([loadStudentData(), loadAttendanceData()]);
        dateFilter.value = new Date().toISOString().split('T')[0];
        filterByDate();
        studentIdInput.focus();
      } catch (error) {
        console.error('Error during initial data load:', error);
      }
    };

    dateFilter.addEventListener('change', filterByDate);
  </script>
</body>
</html>
